# WEBアプリ データ読み込み仕様

## 概要
アーカイブデータ（確定済み）と最新データ（動的）を自動結合して表示するように修正しました。

---

## データ読み込みの流れ

### 1. 初回アクセス時
```
ユーザーがWEBアプリにアクセス
↓
App.tsx の loadCombinedSalesData() が実行
↓
【並列実行】
├─ archive/2023.json を読み込み
├─ archive/2024.json を読み込み
└─ 2025-10-22.json（最新データ）を読み込み
↓
3つのデータを結合
↓
グラフ表示
```

### 2. 2回目以降（基準日変更時）
```
基準日を変更
↓
既に読み込み済みデータを再利用
↓
比較計算のみ実行（高速）
```

---

## ディレクトリ構成

```
web_app/public/data/
  ├── archive/
  │   ├── 2023.json     # 確定データ（固定）
  │   └── 2024.json     # 確定データ（固定）
  └── 2025-10-22.json   # 最新データ（毎日更新）
```

---

## 修正内容

### 1. 型定義の追加
**ファイル**: `src/types/SalesData.ts`

```typescript
export interface ArchiveData {
  year: number;
  archived_at: string;
  total_records: number;
  sales_data: SalesRecord[];
}
```

### 2. データ結合関数の追加
**ファイル**: `src/utils/dataProcessor.ts`

```typescript
export const loadCombinedSalesData = async (latestFilename: string): Promise<SalesData | null>
```

- アーカイブデータを並列読み込み
- 最新データと結合
- エラーハンドリング

### 3. App.tsxの修正
**ファイル**: `src/App.tsx`

- `loadCombinedSalesData()`関数を追加
- `loadDataForDate()`で結合データを使用

---

## 動作確認方法

### 開発サーバーの起動
```bash
cd web_app
npm run dev
```

### 確認ポイント
1. **ブラウザのコンソールを開く**
   - `F12` キーを押下

2. **以下のログが表示されることを確認**
   ```
   読み込み対象アーカイブ: [2023, 2024]
   最新データファイル: 2025-10-22.json
   ✅ 2023年のアーカイブデータ読み込み成功: 12,500 件
   ✅ 2024年のアーカイブデータ読み込み成功: 13,200 件
   ✅ 最新データ読み込み成功: 8,500 件
   📊 データ結合完了:
     アーカイブ件数: 25,700
     最新データ件数: 8,500
     合計: 34,200
   ```

3. **グラフが表示されることを確認**
   - 2023年、2024年、2025年のデータが表示される
   - 前年比較が正しく動作する

---

## 年次運用での変化

### 2025年（現在）
- **アーカイブ**: 2023, 2024
- **最新**: 2025

### 2026年
- **アーカイブ**: 2023, 2024
- **最新**: 2025, 2026（約2年分）

### 2027年
- **アーカイブ**: 2023, 2024, **2025**（追加）
- **最新**: 2026, 2027（約2年分）

**WEBアプリの修正は不要！** 自動的にアーカイブを増やして読み込みます。

---

## パフォーマンス

### 読み込み時間の比較

| データ量 | 従来 | 修正後 |
|---------|------|--------|
| 2025年10月 | 約3年分を毎回読込 | アーカイブ+最新を並列読込 |
| 2026年 | 約4年分を毎回読込 | アーカイブ+最新を並列読込 |
| 2027年 | 約5年分を毎回読込 | アーカイブ+最新を並列読込 |

### メリット
- ✅ アーカイブは並列読み込みで高速化
- ✅ 最新データのみ毎日変更（キャッシュ効率向上）
- ✅ 年数が増えてもパフォーマンス維持

---

## トラブルシューティング

### Q: 2023年のデータが表示されない
**A**: `public/data/archive/2023.json` が存在するか確認してください。
```bash
cd data_generator
uv run python archive_yearly_data.py 2023
```

### Q: コンソールに警告が出る
**A**: アーカイブが見つからない場合は警告のみで続行します。エラーではありません。
```
アーカイブデータが見つかりません: 2023.json
```

### Q: ビルド後に動かない
**A**: `vite.config.ts` の `base` 設定を確認してください。
```typescript
export default defineConfig({
  base: '/your-repo-name/',  // GitHub Pagesの場合
  // ...
})
```

---

## 今後の拡張予定
- [ ] データキャッシュの実装（IndexedDB）
- [ ] オフライン対応
- [ ] データ更新通知機能
